<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProSafe Solutions | Exam Portal (Optimized)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--teal-600:#2d9596}
    html,body{height:100%}
    body{font-family:'Inter',sans-serif;color:#1a202c;background:#f7fafc; overflow-x: hidden;} /* Added overflow-x-hidden */
    .hover-lift{transition:transform .18s,box-shadow .18s}
    .hover-lift:hover{transform:translateY(-6px);box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .exam-option{transition:all .12s;border:2px solid #e5e7eb;padding:1rem;border-radius:.5rem;cursor:pointer}
    .exam-option:hover{border-color:var(--teal-600);background:#f0fdfa}
    .exam-option[aria-pressed="true"]{border-color:var(--teal-600);background:#ccfbf1;box-shadow:0 0 0 3px rgba(45,149,150,.08)}
    /* hide number spinners */
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    
    /* Animation Keyframes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes scorePop {
      0% { transform: scale(0.8); opacity: 0; }
      80% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Animation Classes */
    .fade-in-card {
      opacity: 0; /* Start hidden */
      animation: fadeIn 0.4s ease-out forwards;
    }
    .score-pop-in {
      animation: scorePop 0.4s ease-out forwards;
    }

    /* Page Section Transitions */
    .page-section {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        width: 100%;
    }
    .section-hidden {
        opacity: 0;
        transform: scale(0.98);
        pointer-events: none;
        position: absolute;
        left: 0;
        right: 0;
    }
    .section-visible {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
        position: relative;
    }
    
    /* Answer Review Accordion Transition */
    .answer-review-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        opacity: 0;
    }
    .answer-review-content.expanded {
        opacity: 1;
    }

  </style>
</head>
<body class="flex flex-col min-h-screen">
  <nav class="sticky top-0 z-50 bg-white shadow p-4">
    <!-- ... existing nav code ... -->
    <div class="container mx-auto flex items-center justify-between">
      <a class="flex items-center space-x-3" href="index.html">
        <div class="h-9 w-9 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold">H&amp;S</div>
        <span class="font-bold text-lg">ProSafe Solutions</span>
      </a>
      <div class="hidden md:flex space-x-6 text-sm text-gray-600">
        <a href="index.html" class="hover:text-teal-600">Home</a>
        <a href="risk-zone.html" class="hover:text-teal-600">Risk Zone</a>
        <a href="training.html" class="hover:text-teal-600">Training</a>
        <a href="exam.html" class="text-teal-600 font-semibold border-b-2 border-teal-600">Exam</a>
      </div>
      <button id="menu-toggle" class="md:hidden">â˜°</button>
    </div>
  </nav>

  <!-- Main content wrapper for relative positioning of sections -->
  <main class="flex-grow container mx-auto py-12 px-4 lg:px-12 relative">
    <section id="exam-selection" class="page-section section-visible mb-12">
      <!-- ... existing exam-selection code ... -->
      <div class="text-center mb-10">
        <h1 class="text-3xl font-bold">Certification Exam Portal</h1>
        <p class="text-gray-600 mt-3 max-w-2xl mx-auto">Select an exam to validate your expertise and earn your certification.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- cards generated by JS for flexibility -->
      </div>
    </section>

    <!-- modal -->
    <div id="user-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-outer p-4 opacity-0 transition-opacity duration-200 ease-out">
      <div id="modal-inner" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform scale-95 transition-all duration-200 ease-out">
        <h2 id="modal-title" class="text-xl font-bold mb-2">Begin Exam</h2>
        <p id="modal-sub" class="text-sm text-gray-600 mb-4"></p>
        <form id="user-form" class="space-y-4">
          <!-- ... existing form code ... -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Full name</label>
            <input id="name" required class="mt-1 block w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-teal-300" placeholder="Jane Doe">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Work email</label>
            <input id="email" type="email" required class="mt-1 block w-full px-3 py-2 border rounded-md focus:outline-none focus:ring focus:ring-teal-300" placeholder="you@company.com">
          </div>
          <div class="flex gap-3">
            <button type="button" id="cancel-modal" class="flex-1 py-2 border rounded-md">Cancel</button>
            <button type="submit" class="flex-1 py-2 bg-teal-600 text-white rounded-md">Start Test</button>
          </div>
        </form>
      </div>
    </div>

    <!-- exam view -->
    <section id="exam-view" class="page-section section-hidden">
      <!-- ... existing exam-view code ... -->
      <div class="max-w-3xl mx-auto bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 id="exam-title" class="text-xl font-bold text-teal-600">Exam</h3>
          <div class="text-sm text-gray-700">Question <span id="q-num">1</span> / <span id="q-total">10</span></div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div id="progress" class="h-2.5 rounded-full bg-teal-500 transition-all duration-300" style="width:0%"></div></div>
        <h4 id="question-text" class="text-lg font-semibold mb-4"> </h4>
        <div id="options" class="space-y-3" role="list"></div>
        <div class="flex justify-between mt-6">
          <button id="prev" class="py-2 px-4 border rounded-md">Previous</button>
          <div class="flex gap-3">
            <button id="next" class="py-2 px-4 bg-teal-600 text-white rounded-md">Next</button>
            <button id="submit" class="py-2 px-4 bg-green-600 text-white rounded-md hidden">Submit</button>
          </div>
        </div>
      </div>
    </section>

    <!-- result -->
    <section id="result" class="page-section section-hidden">
      <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6 text-center">
        <h2 class="text-2xl font-bold mb-2">Exam Complete!</h2>
        <p class="text-gray-700 mb-4">Congratulations, <span id="res-name" class="font-semibold"></span>!</p>
        <div class="bg-teal-50 border border-teal-200 rounded p-4 mb-4">
          <div class="text-lg">Score</div>
          <!-- Added ID for score animation -->
          <div class="text-4xl font-bold text-teal-600" id="res-score-display">0 / 0</div>
          <div id="res-percent" class="text-sm text-gray-700">(0%)</div>
        </div>
        
        <button id="view-answers-btn" class="w-full py-2 border border-teal-600 text-teal-600 rounded-md mb-2 hover:bg-teal-50 transition">View Correct Answers</button>
        
        <!-- Updated Answer Key Area with new classes -->
        <div id="answer-key" class="answer-review-content text-left mt-4 p-4 border rounded-md bg-gray-50 max-h-72 overflow-y-auto">
            <!-- Answer key will be injected here -->
        </div>

        <button id="retake" class="w-full py-2 border rounded-md mt-4">Take Another Exam</button>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-gray-400 py-8 mt-auto">
    <div class="container mx-auto text-center text-sm">&copy; 2024 ProSafe Solutions. All rights reserved.</div>
  </footer>

  <script type="module">
    // Lightweight, efficient exam portal script
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- Data (kept small and declarative) ---
    const exams = {
      CSF: {
        title: 'Certified Safety Fundamentals',
        questions: [
          {q:'What does PPE stand for?', o:['Personal Protective Equipment','Private Property Entry','Primary Protocol Estimation','Partial Power Egress'], a:0},
          {q:'What is the first step in a risk assessment?', o:['Control implementation','Hazard identification','Record keeping','Risk calculation'], a:1},
          {q:'A safety sign with a green background indicates:', o:['Prohibition','Warning','Safe condition / First aid','Mandatory action'], a:2},
          {q:'What does "FSW" stand for?', o:['Fire Safety Warden','Factory Site Worker','Fundamental Safety Warning'], a:0},
          {q:'Which is NOT a primary fire extinguisher class?', o:['Class A (Wood, Paper)','Class B (Liquids)','Class C (Electrical)','Class W (Water)'], a:3}
        ]
      },
      ARP: {
        title:'Advanced Risk Professional',
        questions:[
          {q:'What is a HAZOP study?', o:['Hazard and Operability','Hazard Analysis and Operation','Hazardous Operation Protocol'], a:0},
          {q:'What does "LOPA" stand for?', o:['Layer of Protection Analysis','Low-Order Prevention Activity','List of Probable Accidents'], a:0},
          {q:'What is the "Hierarchy of Controls"?', o:['A list of PPE types','A system for prioritizing risk controls','A building safety code'], a:1},
          {q:'Which is the most effective control in the hierarchy?', o:['PPE','Administrative Controls','Elimination','Substitution'], a:2},
          {q:'What is a "Bowtie Analysis" used for?', o:['To tie safety knots','To visualize risk pathways from cause to consequence','To calculate fire extinguisher size'], a:1}
        ]
      },
      FSW: {
        title:'Fire Safety Warden',
        questions:[
          {q:'What are the three elements of the fire triangle?', o:['Fuel, Oxygen, Heat','Wood, Water, Air','Sparks, Gas, Alarm'], a:0},
          {q:'What does a Class C fire involve?', o:['Flammable liquids','Combustible metals','EnergIZED electrical equipment'], a:2},
          {q:'What does P.A.S.S. stand for when using an extinguisher?', o:['Pull, Aim, Squeeze, Sweep','Push, Alert, Squeeze, Spray','Pull, Aim, Stand, Spray'], a:0},
          {q:'What is the primary role of a Fire Safety Warden?', o:['To fight the fire','To ensure the safe evacuation of their designated area','To call the fire department'], a:1}
        ]
      }
    };

    // --- Cached DOM ---
    // *** FIX: Restored all cached DOM elements ***
    const dom = {
      selection: document.querySelector('#exam-selection .grid'),
      modal: document.getElementById('user-modal'),
      modalInner: document.getElementById('modal-inner'),
      modalTitle: document.getElementById('modal-title'),
      modalSub: document.getElementById('modal-sub'),
      userForm: document.getElementById('user-form'),
      name: document.getElementById('name'),
      email: document.getElementById('email'),
      cancelModalBtn: document.getElementById('cancel-modal'), // <-- Was missing
      examView: document.getElementById('exam-view'),
      examTitle: document.getElementById('exam-title'),
      qNum: document.getElementById('q-num'),
      qTotal: document.getElementById('q-total'),
      progress: document.getElementById('progress'),
      questionText: document.getElementById('question-text'),
      options: document.getElementById('options'),
      prevBtn: document.getElementById('prev'),
      nextBtn: document.getElementById('next'),
      submitBtn: document.getElementById('submit'),
      resultSec: document.getElementById('result'),
      resName: document.getElementById('res-name'),
      resScore: document.getElementById('res-score-display'),
      resPercent: document.getElementById('res-percent'),
      viewAnswersBtn: document.getElementById('view-answers-btn'), 
      answerKey: document.getElementById('answer-key'),
      retakeBtn: document.getElementById('retake'),
      allSections: document.querySelectorAll('.page-section')
    };
    // ******************************************

    // --- State ---
    let currentExamKey = null;
    let currentExam = null;
    let qIndex = 0;
    let answers = [];
    let user = {name: '', email: ''};
    let lastExamDetails = []; 

    // --- Firebase (optional) ---
    let db = null, auth = null;
    const firebaseConfig = {
      apiKey: "AIzaSyCLx0Cq_SXgQ95Iwu48KOQGnm2WLdxtDEE",
      authDomain: "prosafe-exams-database.firebaseapp.com",
      projectId: "prosafe-exams-database",
      storageBucket: "prosafe-exams-database.appspot.com",
      messagingSenderId: "623703875595",
      appId: "1:623703875595:web:b5444acd3c96ff42bd270e"
    };

    (async function initFirebase(){
      try{
        if(!firebaseConfig.apiKey) return;
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        await signInAnonymously(auth);
        console.log('Firebase ready', auth.currentUser?.uid);
      }catch(e){
        console.warn('Firebase init failed (safe to ignore in dev):', e.message || e);
        db = null;
      }
    })();

    // --- Utility ---
    const el = (tag, attrs={}, ...children)=>{ 
        const n=document.createElement(tag); 
        for(const k in attrs) { 
            if(k.startsWith('on') && typeof attrs[k]==='function') n.addEventListener(k.slice(2), attrs[k]); 
            else if(k==='html') n.innerHTML=attrs[k]; 
            else n.setAttribute(k, attrs[k]); 
        } 
        children.flat().forEach(c=>{ 
            if(typeof c==='string') n.appendChild(document.createTextNode(c)); 
            else if(c) n.appendChild(c); 
        }); 
        return n; 
    };

    // Render exam cards
    function renderExamCards(){
      dom.selection.innerHTML='';
      Object.entries(exams).forEach(([key,ex], idx)=>{ 
        const card = el('div',{
            class:'bg-white p-6 rounded-lg shadow hover-lift flex flex-col items-center text-center fade-in-card', 
            style: `animation-delay: ${idx * 100}ms` 
          },
          el('div',{class:'h-14 w-14 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center mb-3'}, el('svg',{class:'w-6 h-6', fill:'none', stroke:'currentColor', viewBox:'0 0 24 24'}, el('path',{ 'stroke-linecap':'round', 'stroke-linejoin':'round', 'stroke-width':'2', d:'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}))),
          el('h3',{class:'font-bold text-lg mb-2'}, ex.title),
          el('p',{class:'text-gray-600 mb-4'}, `${ex.questions.length} question(s)`),
          el('button',{class:'w-full py-2 px-4 bg-teal-600 text-white rounded-md',onclick:()=>openModal(key)}, 'Start Exam')
        );
        dom.selection.appendChild(card);
      });
    }

    // --- NEW: Animated Modal Functions ---
    function openModal(exKey){
      currentExamKey = exKey;
      currentExam = exams[exKey];
      dom.modalTitle.textContent = `Begin: ${currentExam.title}`;
      dom.modalSub.textContent = 'Please enter your details to start the exam.';
      
      dom.modal.classList.remove('hidden');
      requestAnimationFrame(() => { 
          dom.modal.classList.remove('opacity-0');
          dom.modalInner.classList.remove('scale-95');
      });

      const saved = JSON.parse(localStorage.getItem('prosafe_user')||'{}');
      if(saved.name) dom.name.value = saved.name;
      if(saved.email) dom.email.value = saved.email;
    }

    function closeModal() {
        dom.modal.classList.add('opacity-0');
        dom.modalInner.classList.add('scale-95');
        setTimeout(() => {
            dom.modal.classList.add('hidden');
            dom.userForm.reset();
        }, 200); 
    }

    // *** FIX: Changed to use the cached dom.cancelModalBtn ***
    dom.cancelModalBtn.addEventListener('click', closeModal); 
    dom.modal.addEventListener('click', (e) => { 
        if (e.target === dom.modal) {
            closeModal();
        }
    });
    // ******************************************************
    
    dom.userForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      user.name = dom.name.value.trim(); user.email = dom.email.value.trim();
      if(!user.name || !user.email) return;
      localStorage.setItem('prosafe_user', JSON.stringify(user));
      closeModal(); 
      startExam();
    });

    function startExam(){
      qIndex = 0; answers = new Array(currentExam.questions.length).fill(null);
      dom.examTitle.textContent = currentExam.title;
      dom.qTotal.textContent = currentExam.questions.length;
      showSection('exam-view'); 
      renderQuestion();
    }

    // --- NEW: Animated Section Transition ---
    function showSection(sectionId){
        dom.allSections.forEach(sec => {
            if (sec.id === sectionId) {
                sec.classList.remove('section-hidden');
                sec.classList.add('section-visible');
            } else {
                sec.classList.add('section-hidden');
                sec.classList.remove('section-visible');
            }
        });
        window.scrollTo(0, 0);
    }

    function renderQuestion(){
      const q = currentExam.questions[qIndex];
      dom.qNum.textContent = qIndex+1;
      dom.questionText.textContent = q.q;
      dom.progress.style.width = `${Math.round(((qIndex+1)/currentExam.questions.length)*100)}%`;
      dom.options.innerHTML = '';
      q.o.forEach((option, idx)=>{
        const btn = el('button',{class:'exam-option w-full text-left', role:'listitem', 'aria-pressed': String(answers[qIndex]===idx)}, option);
        btn.addEventListener('click', ()=>{
          answers[qIndex]=idx; updateOptionsUI();
        });
        dom.options.appendChild(btn);
      });
      updateNav();
    }

    function updateOptionsUI(){
      Array.from(dom.options.children).forEach((child,idx)=> child.setAttribute('aria-pressed', String(answers[qIndex]===idx)));
    }

    function updateNav(){
      dom.prevBtn.disabled = qIndex===0;
      const last = qIndex===currentExam.questions.length-1;
      dom.nextBtn.classList.toggle('hidden', last);
      dom.submitBtn.classList.toggle('hidden', !last);
    }

    dom.prevBtn.addEventListener('click', ()=>{ if(qIndex>0){ qIndex--; renderQuestion(); } });
    dom.nextBtn.addEventListener('click', ()=>{ if(qIndex < currentExam.questions.length-1){ qIndex++; renderQuestion(); } });

    dom.submitBtn.addEventListener('click', async ()=>{
      let score=0; const total = currentExam.questions.length;
      const detailed = currentExam.questions.map((qq,i)=>{
        const ua = answers[i]; const ca = qq.a; if(ua===ca) score++;
        return {questionNumber:i+1,questionText:qq.q,userAnswer: ua===null? 'No Answer': qq.o[ua], correctAnswer: qq.o[ca], isCorrect: ua===ca};
      });
      const percent = Math.round((score/total)*100);
      lastExamDetails = detailed; 

      const payload = {userName:user.name,userEmail:user.email,examKey:currentExamKey,examTitle:currentExam.title,score,total,percentage:percent,detailedAnswers:detailed,timestamp: serverTimestamp ? serverTimestamp() : Date.now(), userId: auth?.currentUser?.uid || 'anonymous'};
      if(db){
        try{ await addDoc(collection(db,'examResults'), payload); console.log('Saved exam result'); }catch(e){ console.warn('Save failed',e.message||e); }
      }

      dom.resName.textContent = user.name;
      dom.resScore.textContent = `${score} / ${total}`;
      dom.resPercent.textContent = `(${percent}%)`;
      
      dom.resScore.classList.remove('score-pop-in'); 
      void dom.resScore.offsetWidth; 
      dom.resScore.classList.add('score-pop-in'); 

      dom.answerKey.classList.remove('expanded');
      dom.answerKey.style.maxHeight = '0';
      dom.answerKey.innerHTML = '';

      showSection('result'); 
    });

    dom.retakeBtn.addEventListener('click', ()=>{
      currentExamKey = null; currentExam = null; answers = []; qIndex = 0; 
      
      dom.answerKey.classList.remove('expanded');
      dom.answerKey.style.maxHeight = '0';
      dom.answerKey.innerHTML = '';
      lastExamDetails = [];

      showSection('exam-selection'); 
    });

    dom.viewAnswersBtn.addEventListener('click', () => {
        const content = dom.answerKey;
        if (content.classList.toggle('expanded')) {
            if (content.innerHTML === '') { 
                const list = el('ul', { class: 'space-y-3' });
                lastExamDetails.forEach(item => {
                    const li = el('li', { class: 'border-b pb-2' },
                        el('p', { class: 'font-semibold text-gray-800' }, `Q: ${item.questionText}`),
                        el('p', { class: 'text-green-600 font-medium' }, `A: ${item.correctAnswer}`)
                    );
                    list.appendChild(li);
                });
                content.appendChild(list);
            }
            content.style.maxHeight = content.scrollHeight + 'px';
        } else {
            content.style.maxHeight = '0';
        }
    });

    // init
    renderExamCards();
    showSection('exam-selection'); 

    window.__ProSafe = {exams, startExam};
  </script>
</body>
</html>

